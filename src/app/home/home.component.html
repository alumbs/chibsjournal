<div #mainContainer class="container">
    <p-toast></p-toast>
    <p-confirmPopup></p-confirmPopup>
    <p-sidebar [styleClass]="isMobile ? 'mobile-sidebar' : 'desktop-sidebar'" 
               [modal]="isMobile ? true : false"
               [dismissible]="true"
               [closeOnEscape]="true"
               [(visible)]="visible"
               (onHide)="visible = false;">
        <p-scrollPanel [style]="{width: '100%', height: '100%'}">
            <div class="sidebarContent">
                <div class="sidebar-header">
                    <h4>Journal Entries <span class="entry-count-badge">{{entryCount}}</span></h4>
                </div>

                <!-- Journal List Selector -->
                <div class="mb-3">
                    <label class="sidebar-label">Journal List</label>
                    <p-dropdown [options]="journalLists" [ngModel]="(activeJournalList$ | async)" optionLabel="name"
                        (ngModelChange)="activeJournalList$.next($event)" [style]="{'width': '100%'}"></p-dropdown>
                </div>

                <!-- Close Menu Checkbox -->
                <div class="mb-3">
                    <p-checkbox [ngModel]="closeMenuOnSelection" 
                                (ngModelChange)="closeMenuOnSelection = $event"
                                [binary]="true"
                                label="Close Menu On Selection" 
                                inputId="closeMenuCheckbox"></p-checkbox>
                </div>

                <div class="mb-3">
                    <input type="text" pInputText placeholder="Search entries..." 
                           class="search-input w-full"
                           (input)="updateSearchTerm($any($event.target).value)">
                </div>
                <div class="mb-3">
                    <label class="sort-label">Sort by:</label>
                    <p-dropdown [options]="sortOptions" [(ngModel)]="sortOption" 
                                optionLabel="label" optionValue="value"
                                (ngModelChange)="updateSortOption($event)"
                                [style]="{'width': '100%'}"></p-dropdown>
                </div>
                <ul class="journalEntries">
                    <li *ngFor="let entry of journalEntries$ | async" class="singleJournalEntry">
                        <div class="deleteJournalEntrySection">
                            <i class="mr-1 mt-1 pi pi-times  deleteJournalEntryIcon"
                                (click)="deleteJournalEntry($event, entry)" title="delete journal entry"></i>
                        </div>
                        <a (click)="setActiveEntry(entry)">{{entry.title}}</a>
                    </li>
                </ul>
            </div>

        </p-scrollPanel>
    </p-sidebar>
    <div class="main-content" [style.margin-left]="!isMobile && visible ? '300px' : '0px'">
        <i class="mb-3 pi pi-align-justify text-2xl text-color-secondary" (click)="$event.stopPropagation(); visible = !visible"></i>

        <div *ngIf="activeJournalEntry; else noActiveJournalEntry" (click)="$event.stopPropagation()">
            <div class="card flex justify-content-center mb-1">
                <p-button *ngIf="activeJournalEntry.id" class="mr-1" icon="pi pi-plus" label="New Entry"
                    styleClass="p-button p-button-rounded p-button-help" (onClick)="createNewActiveEntry()"></p-button>

                <p-button [label]="activeJournalEntry.id ? 'Update Entry' : 'Save Entry'" class="mr-1"
                    styleClass="p-button p-button-rounded p-button-success" (onClick)="saveActiveEntry()"></p-button>

                <p-button *ngIf="activeJournalEntry.id" styleClass="p-button p-button-rounded p-button-danger"
                    [label]="'Delete Entry'" (onClick)="deleteJournalEntry($event, activeJournalEntry)"></p-button>
            </div>

            <div class="journalHeader" [class.mobile-stack]="isMobile">
                <div class="title-section mr-1">
                    <h3>Title</h3>
                    <input class="entryTitle mb-1 mr-1" type="text" pInputText placeholder="Journal Entry Title - Date"
                        name="title" id="title" [(ngModel)]="activeJournalEntry.title"
                        (ngModelChange)="journalContentUpdate$.next($event)" autofocus>
                </div>

                <div class="date-section mb-1">
                    <h3>Created Date</h3> <p-calendar [(ngModel)]="activeJournalEntry.createdDateAsDate"></p-calendar>
                </div>
            </div>

            <div class="editor-container">
                <div class="editor-toolbar-actions mb-1">
                    <p-button icon="pi pi-window-maximize" 
                              label="Fullscreen Editor"
                              styleClass="p-button-sm p-button-info"
                              (onClick)="openFullscreenEditor()"></p-button>
                </div>
                
                <p-editor #editor required [(ngModel)]="activeJournalEntry.content" [modules]="modules"
                    (ngModelChange)="journalContentUpdate$.next($event)" 
                    class="pEditor">
                </p-editor>
            </div>

            <div class="mt-1">
                <p-button [label]="activeJournalEntry.id ? 'Update Entry' : 'Save Entry'"
                    styleClass="p-button p-button-rounded p-button-success" (onClick)="saveActiveEntry()"></p-button>
            </div>

        </div>


        <ng-template #noActiveJournalEntry>
            <div class="mb-1" (click)="$event.stopPropagation()">
                No Journal entry is selected. Please select a journal entry or create a new one
            </div>

            <p-button icon="pi pi-plus" label="New Entry" class="mt-1"
                styleClass="p-button p-button-rounded p-button-help" (onClick)="createNewActiveEntry()"></p-button>

        </ng-template>
    </div>

    <p-dialog header="Fullscreen Editor" [(visible)]="isFullscreen" [modal]="true" [dismissableMask]="true"
        [closeOnEscape]="true" [style]="{ width: '95vw', maxWidth: '1200px' }" [contentStyle]="{ height: '80vh' }" *ngIf="activeJournalEntry">
        <div class="fullscreen-editor-body">
            <p-editor required [(ngModel)]="activeJournalEntry.content" [modules]="modules"
                (ngModelChange)="journalContentUpdate$.next($event)" class="pEditor fullscreen-editor"></p-editor>
        </div>
    </p-dialog>
</div>